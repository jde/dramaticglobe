<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>

  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>

  <style>

    #api_ad_container {
      margin: 0 auto;
      width: 500px;
      height: 600px;

      overflow: hidden;

      text-align: right;

      background-image: url('assets/reuters_worldnews_expanded.png');

      position: relative;

    }

    #globe {
      margin-top: 100px;
    }

    #bureau {
      position: absolute;
      top: 100px;
      right: 18px;

      font-size: 1.5em;
      color: #f80;

    }

    .bureau {
      fill: #f80;
      stroke: #f80;
      stroke-width: 0;
      -webkit-transition: all 2.5s;
    }

    .land {
      fill: #DEDEEF;
      stroke: none;
    }

    .selected {
      fill: #f80;
      stroke: #fff;
      stroke-width: 2;
      -webkit-transition: all 2.5s;
    }


  </style>
</head>
<body>


  <div id="api_ad_container">
    <div id="bureau">
    </div>
  </div>

  <script>

  var containerSelector = "#api_ad_container";

  var bureaus = [],
      bureauShapes = [],
      selectedBureau;

  var bureauInfo = document.getElementById("bureau");

  var width = 960,
      height = 500;

  var mapData, bureauData;

  var shapes, paths;

  var animationDuration = 3000,
      animationInterval;

  var dataSources = 0, 
      dataLoaded = 0;

  var projection = d3.geo.orthographic()
      .scale(450)
      .translate([100, 500])
      .clipAngle(90);

  var path = d3.geo.path()
      .projection(projection);

  var svg = d3.select(containerSelector).append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("id", "globe");

  // draw world paths
  dataSources++;
  d3.json("data/world-110m.json", function(error, world) {

    mapData = world;

    dataLoaded++;
    ready();

  });

  // draw bureaus
  dataSources++;
  d3.csv("data/tr-bureaus-ll.csv", function (d) {
    return {
      id: Number(d.id),
      latitude: Number(d.latitude),
      longitude: Number(d.longitude),
      name: d.desc
    }
  }, function (error, rows) {

    bureauData = rows;

    dataLoaded++;
    ready();

  });


  var moveTo = function () {

    // strip selected from the current bureau
    if (typeof selectedBureau !== "undefined") {
      document.getElementById("bureau"+selectedBureau).className = "bureau";

      console.log(document.getElementById("bureau"+selectedBureau));
      console.log("bureau"+selectedBureau);
    }

    selectedBureau = Math.floor(Math.random() * bureauData.length);
    var to = bureauData[selectedBureau];

    bureauInfo.innerHTML = to.name;

    // rotate globe
    d3.transition()
        .duration(2500)
        .tween("rotate", function() {
          var p = d3.geo.centroid(bureauShapes[selectedBureau+1]),
              r = d3.interpolate(projection.rotate(), [-p[0] + 40, -p[1] + 40]);

          return function(t) {

            projection.rotate(r(t));
            paths.attr("d", path);

          };
        })
      .transition();


    // animate selected circle

    d3.select("#bureau" + (selectedBureau))
        .attr("class", "selected")
        .transition()
        .duration(2500);

  };


  /*
    Interactivity
  */

  var enableMouseMove = function () {
    var λ = d3.scale.linear()
          .domain([0, width])
          .range([-360, 360]);

    var φ = d3.scale.linear()
        .domain([0, height])
        .range([90, -90]);

    svg.on("mousemove", function() {
      var p = d3.mouse(this);
      projection.rotate([λ(p[0]), φ(p[1])]);
      svg.selectAll("path").attr("d", path);
    });
  }

  var startAnimation = function() {
    animationInterval = setInterval(moveTo, animationDuration);
  }
  var stopAnimation = function() {
    clearInterval(animationInterval);
  }

  d3.select(containerSelector).on("mouseenter", stopAnimation);
  d3.select(containerSelector).on("mouseleave", startAnimation);

  /*
     /Interactivity
  */



  var ready = function () {

    if (dataLoaded !== dataSources) {
      return;
    }

    // draw the map
    svg.append("path")
        .datum(topojson.feature(mapData, mapData.objects.land))
        .attr("class", "land")
        .attr("d", path);


    // draw the bureaus
    bureauShapes = bureauData.map(function(r) { 
      var polygon = d3.geo.circle().origin([ r.longitude, r.latitude]).angle(1.0)();
      polygon.data = r; // is this a hack or brilliance?
      return polygon;
    });

    svg.selectAll()
        .data(bureauShapes)
          .enter().append("path")
          .attr("class", "bureau")
          .attr("d", path)
          .attr("id", function (b) { return "bureau"+b.data.id}); // brilliance

    // CACHE ALL THE THINGS!!!
    paths = svg.selectAll("path");

    enableMouseMove();
    startAnimation();

  }


/*
  // this code rotates the globe on mousemove
  var λ = d3.scale.linear()
      .domain([0, width])
      .range([-180, 180]);

  var φ = d3.scale.linear()
      .domain([0, height])
      .range([90, -90]);

  svg.on("mousemove", function() {
    var p = d3.mouse(this);
    projection.rotate([λ(p[0]), φ(p[1])]);
    svg.selectAll("path").attr("d", path);
  });
*/



  </script>
</body>
</html>