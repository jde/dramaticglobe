<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>

  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>

  <style>

    #container {
      margin: 0 auto;
      width: 500px;
      height: 600px;

      overflow: hidden;

      text-align: right;

    }

    .bureau {
      fill: rgba(255, 128, 0, 1);
      stroke: none;
    }

    .land {
      fill: rgba(0,0,0,.5);
      stroke: rgba(1,1,1,1);
      stroke-width: .5;
    }

    .selected {
      fill: rgba(128, 255, 0, 1);      
    }


  </style>
</head>
<body>


  <div id="container">
    <h1>Thompson Reuters</h1>
    <p>International news etc...<p>
    <div id="bureau">
    </div>
  </div>

  <script>

  var bureaus = [],
      bureauShapes = [];

  var bureauInfo = document.getElementById("bureau");

  var width = 960,
      height = 500;

  var projection = d3.geo.orthographic()
      .scale(450)
      .translate([100, 500])
      .clipAngle(90);

  var path = d3.geo.path()
      .projection(projection);

  var svg = d3.select("#container").append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("id", "globe");

  // draw world paths
  d3.json("data/world-110m.json", function(error, world) {
    svg.append("path")
        .datum(topojson.feature(world, world.objects.land))
        .attr("class", "land")
        .attr("d", path);
  });

  // draw bureaus
  d3.csv("data/tr-bureaus-ll.csv", function (d) {
    return {
      id: Number(d.id),
      latitude: Number(d.latitude),
      longitude: Number(d.longitude),
      name: d.desc
    }
  }, function (error, rows) {

    bureaus = rows;

    bureauShapes = rows.map(function(r) { 
      var polygon = d3.geo.circle().origin([ r.longitude, r.latitude]).angle(1.0)();
      polygon.data = r; // is this a hack or brilliance?
      return polygon;
    });

    svg.selectAll("path.tissot")
        .data(bureauShapes)
      .enter().append("path")
        .attr("class", "bureau")
        .attr("d", path)
        .attr("id", function (b) { return "bureau"+b.data.id}); // brilliance

  });


  var moveTo = function () {

    var newId = Math.floor(Math.random() * bureaus.length)-1;
    var to = bureaus[newId];

    bureauInfo.innerHTML = to.name;


    d3.transition()
        .duration(2500)
        .tween("rotate", function() {
          var p = d3.geo.centroid(bureauShapes[newId]),
              r = d3.interpolate(projection.rotate(), [-p[0] + 40, -p[1] + 40]);
          
          return function(t) {

            projection.rotate(r(t));

            svg.selectAll("path")
              .attr("d", path)
              .attr("class", function (b) {

                if (! b.data) {
                  return "land";
                }

                if (t > .9 && b.data.id === newId+1) {
                  return "bureau selected";
                }
                return "bureau";
              });

          };
        })
      .transition();

  };

  setInterval(moveTo, 4000);

/*
  // this code rotates the globe on mousemove
  var λ = d3.scale.linear()
      .domain([0, width])
      .range([-180, 180]);

  var φ = d3.scale.linear()
      .domain([0, height])
      .range([90, -90]);

  svg.on("mousemove", function() {
    var p = d3.mouse(this);
    projection.rotate([λ(p[0]), φ(p[1])]);
    svg.selectAll("path").attr("d", path);
  });
*/



  </script>
</body>
</html>